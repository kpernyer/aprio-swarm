# Multi-stage build for simple test
FROM rust:1.80-alpine AS builder

# Install musl-dev for static linking
RUN apk add --no-cache musl-dev

# Set target for static linking
ENV RUSTFLAGS="-C target-feature=+crt-static"

# Create app directory
WORKDIR /app

# Copy manifests
COPY Cargo.toml ./
COPY crates/ ./crates/
COPY examples/simple-test/ ./examples/simple-test/

# Build the simple test
RUN cargo build --release --target x86_64-unknown-linux-musl --package simple-test

# Final stage - FROM scratch for minimal size
FROM scratch

# Copy the statically linked binary
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/simple-test /app/simple-test

# Set working directory
WORKDIR /app

# Default command
CMD ["./simple-test"]
